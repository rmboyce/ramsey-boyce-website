// Parts of this code from xroz
// xroz - play crosswords within your browser
// Author: Alex Stangl  8/14/2011
// Copyright 2011, Alex Stangl. All Rights Reserved.
// Licensed under ISC license (see LICENSE file)
// https://github.com/astangl/xroz/blob/master/LICENSE

// Remainder of this code (c) 2016 Alex Boisvert
// licensed under MIT license
// https://opensource.org/licenses/MIT
var ActiveXObject,parsedPuz,filecontents,PUZAPP={};!function(){"use strict";function K(t,s){return t.charCodeAt(s)%256}function X(){this.DIRECTION_ACROSS=1,this.DIRECTION_DOWN=-1,this.DIRECTION_UNKNOWN=0,this.storageKey=function(){return"xroz."+this.url+".state"},this.innerHeight=function(){return document.getElementsByTagName("html")[0].clientHeight-2*this.BODY_MARGIN},this.innerWidth=function(){return document.getElementsByTagName("html")[0].clientWidth-2*this.BODY_MARGIN},this.toIndex=function(t,s){return s*this.width+t},this.fromIndex=function(t){return[t%this.width,Math.floor(t/this.width)]},this.isBlack=function(t,s){return"."===this.solution.charAt(this.toIndex(t,s))},this.cursorBlack=function(){return this.isBlack(this.cursorX,this.cursorY)},this.circled=function(t){return void 0!==this.gext&&0!=(128&K(this.gext,t))},this.startDownWord=function(t,s){return(0===s||this.isBlack(t,s-1))&&s<this.height-1&&!this.isBlack(t,s)&&!this.isBlack(t,s+1)},this.startAcrossWord=function(t,s){return(0===t||this.isBlack(t-1,s))&&t<this.width-1&&!this.isBlack(t,s)&&!this.isBlack(t+1,s)},this.getWordNbr=function(t,s){var r=this.direction,i=this.toIndex(t,s);return r===this.DIRECTION_UNKNOWN?0:r===this.DIRECTION_ACROSS?this.acrossWordNbrs[i]:this.downWordNbrs[i]},this.supportsLocalStorage=function(){try{return void 0!==window.localStorage&&null!==window.localStorage}catch(t){return!1}}()}function Y(t,s){return K(t,s)+256*K(t,s+1)}function Z(t,s,r,i){var n;for(n=0;n<r;++n)i%2?i=(i-1)/2+32768:i/=2,i+=K(t,s+n);return i}function t(t){if(!t.match("ACROSS&DOWN"))throw alert("Not a .puz file!"),{name:"BADMAGICNUMBER",message:"File did not contain expected magic number, contained '"+d+"'."};var s,r,i,n,e,o,c,u,h,a,l=new X,d=t.substring(2,14),g=Z(t,44,8,0),f=K(t,44),N=K(t,45),m=f*N,b=52+m,w=b+m,p=Z(t,52,m,g),B=Y(t,46),C=function(t,s,r,i){for(var n=s;0<i;)t[n++]===r&&i--;return n}(t,w,"\0",B+4),I=1,A=0,W=0,O=[],D=[],k=[],x=[],S=[],v=[],R=[];if("ACROSS&DOWN\0"!==d)throw alert("Not a .puz file!"),{name:"BADMAGICNUMBER",message:"File did not contain expected magic number, contained '"+d+"'."};l.version=t.substring(24,27),l.width=f,l.height=N,l.nbrClues=B,l.solution=t.substring(52,52+m),l.strings=t.substring(w).split("\0",B+4),l.grid=t.substring(b,b+m),-1==l.grid.indexOf("-")&&(l.solution=l.grid),p=Z(t,b,m,p);for(c=0;c<N;c++)for(o=0;o<f;o++,W++)h=l.startDownWord(o,c),u=l.startAcrossWord(o,c),s=I.toString(),k.push(h||u?s:""),a=l.isBlack(o,c),x.push(h?I:a||0===c?0:x[W-f]),S.push(u?I:a||0===o?0:S[W-1]),(h||u)&&(u&&(O.push(I),O.push(A++),v.push(I)),h&&(D.push(I),D.push(A++),R.push(I)),I++);for(l.acrossClues=O,l.downClues=D,l.sqNbrs=k,l.acrossWordNbrs=S,l.downWordNbrs=x,l.acrossSqNbrs=v,l.downSqNbrs=R;C<t.length;){if(r=t.substring(C,C+4),i=Y(t,C+4),(n=Y(t,C+6))!==(e=Z(t,C+8,i,0)))throw{name:"BadExtraSectionChecksum",message:"Extra section "+r+" had computed checksum "+e+", versus given checksum "+n};"GEXT"===r&&(l.gext=t.substring(C+8,C+8+i)),C+=i+9}l.title=l.strings[0],l.author=l.strings[1],l.copyright=l.strings[2];var E=l.strings.slice(3,3+l.nbrClues),_={},P={},T={},M={},U=l.nbrClues,z=0,y=0;for(c=0;c<N;c++)for(o=0;o<f;o++,W++){h=l.startDownWord(o,c),u=l.startAcrossWord(o,c),a=l.isBlack(o,c);var G=l.toIndex(o,c);u?(T[z=S[G]]=E[0],U--,E=E.slice(1,1+U),_[z]=l.solution[G]):a||(_[z]+=l.solution[G]),h&&(M[y=x[G]]=E[0],U--,E=E.slice(1,1+U))}var q=l.strings.slice(3+l.nbrClues,4+l.nbrClues);for(l.notes="",q[0]&&(l.notes=q[0]),l.circles=[],o=0;o<f;o++)for(c=0;c<N;c++){h=l.startDownWord(o,c),a=l.isBlack(o,c);G=l.toIndex(o,c);h?P[y=x[G]]=l.solution[G]:a||(P[y]+=l.solution[G]),l.circles[G]=l.circled(G)}return l.across_entries=_,l.across_clues=T,l.down_clues=M,l.down_entries=P,PUZAPP.puzdata=l}PUZAPP.parsepuz=t}();